# SQL (Relational)

>[!Note]- When to use Relational Database
> <!-- Multiline -->
> 1. **~={purple}Structured Data=~**:
> 2. **~={purple}ACID=~**:
> 3. **~={purple}Frequent Joins=~**:
> 

>[!Note]- What is an RDBMS?
> <!-- Multiline -->
>* **~={purple}Stored on Disk=~**: We want the data to be persisted
>* **~={purple}Data Structure=~**: B+ Tree is used for RDBMS indexing. It is an index for the actual data stored on disk, where the B+ Tree is loaded into memory upon an SQL query.
>	* Each node has $m$ children. 
>		* **~={green}Internal Nodes=~**: Stores $(key, pointer)$, where the pointers point to children nodes
>		* **~={green}Leaf Nodes=~**: Stores $(key, pointer)$, where the pointer points to a data record (Row in SQL Table). Th
>		
> ![[Drawing 2025-02-04 08.08.31.excalidraw | center | 700]]

>[!Note]- What is ACID?
> <!-- Multiline -->
>1. **~={red}Durability=~**: RDBMS is stored on disk. Every transaction that is made which is **~={blue}committed=~**, then it should be persisted.
>2. **~={red}Atomicity=~**: Transactions are performed **~={blue}in it's entirety=~**, or not at all. (A transaction is X number of SQL queries)
>3. **~={red}Isolation=~**: When we have multiple transactions happening concurrently, we want them to appear as if transactions are **~={blue}happening in order=~**. This means we want the schedule of transactions to be **~={green}serialisable=~**. (i.e. T1 -> T2, rather then T1 & T2)
>4. **~={red}Consistency Prevention=~**: Takes the database from one **~={blue}consistent state=~** to another **~={blue}consistent state=~**. A consistent state is a state that follows all constraints set by our RDBMS (i.e. column $x$ needs to be unique)
> 

>[!Note]- What happens if Isolation and Consistency aren't met?
> <!-- Multiline -->
> * **~={blue}A Write Operation=~**: Updates the value on the disk
> * **~={blue}Commit Operation=~**: Makes the change permanent
>1. **~={red}Lost Update=~**:
>````col
>```col-md
> ![[Drawing 2025-02-05 08.10.23.excalidraw | center | 450]]
>```
>```col-md
>* T1 Updates X
>* T2 Updates X
>* T1 Changes are Written to the Disk
>* T2 Changes are Written to the Disk without accounting for T1's Changes
>```
>````
>2. **~={red}Dirty Read=~**:
>````col
>```col-md
>![[Drawing 2025-02-04 08.34.07.excalidraw | center | 450]]
>```
>```col-md
>* T1 Updates X
>* T2 Reads Updated X
>* T1 Fails for Some Reason. Hence the value that T2 read is no longer correct.
>```
>````
> 
>3. **~={red}Unrepeatable Read=~**:
>````col
>```col-md
> ![[Drawing 2025-02-05 08.15.50.excalidraw | center | 450]]
>```
>```col-md
>* T1 and T2 Read X
>* T1 Updates X
>* T2 Reads X
>* T2 read X twice in the same transaction but it yielded a different value each time. This should not happen.
>```
>````
>4. **~={red}Phantom Read=~**:
>````col
>```col-md
> ![[Drawing 2025-02-05 08.27.56.excalidraw | center | 450]]
>```
>```col-md
>* T1 and T2 Read X
>* T1 Deletes X
>* T2 Reads X
>* T2 Reads X, but the value has now been deleted leading to an error
>```
>````

>[!Note]- Isolation Levels
> <!-- Multiline -->
> There are a few isolation levels that can be set on a database:
> 
> ![[Drawing 2025-02-05 09.02.27.excalidraw | center | 600]]
>

>[!Note]- Concurrency Control Mechanisms: Pessimistic Concurrency Control
> <!-- Multiline -->
> **~={blue}Traits=~**:
> * Pessimistic locking works by **locking rows or tables** to prevent concurrent transactions from modifying data in conflicting ways. It ensures data integrity by **blocking other transactions until the current one completes**.
> * **~={green}Shared Lock=~**: Read Lock
> * **~={red}Exclusive Lock=~**: Write Lock
> 
> ![[Drawing 2025-02-05 13.32.11.excalidraw | center | 300]]
> **~={blue}How it Prevents=~**:
>1. **~={red}Lost Update=~**:
>````col
>```col-md
>**~={green}With Pessimistic Locking=~**
> ![[Drawing 2025-02-05 13.02.51.excalidraw]]
>
>```
>```col-md
>**~={red}Why it Works=~**
>* **~={blue}Exclusive Lock=~**: Prevents T2 from reading and updating data that T1 has an exclusive lock on. Hence we cannot write to stale data.
>* **~={red}Ensures only one transaction modifies a row at a time.=~**
>```
>````
>2. **~={red}Dirty Read=~**:
>````col
>```col-md
> ![[Drawing 2025-02-05 13.10.31.excalidraw]]
>```
>```col-md
>**~={red}Why it Works=~**
>* **~={blue}Exclusive Lock=~**: Prevents T2 from reading data that T1 has an exclusive lock on. Hence, we cannot read stale data.
>* **~={red}Prevents reading uncommitted changes.=~**
>```
>````
> 
>3. **~={red}Unrepeatable Read=~**:
>````col
>```col-md
> ![[Drawing 2025-02-05 13.16.02.excalidraw]]
>```
>```col-md
>**~={red}Why it Works=~**
>* **~={blue}Shared Lock=~**: Prevents T2 from modifying data T1 is currently reading/has a shared lock on. Hence, when T1 re-reads that value, it remains the same.
>* **~={red}Ensures a row cannot change while being read.=~**
>```
>````
>4. **~={red}Phantom Read=~**:
>````col
>```col-md
> ![[Drawing 2025-02-05 13.28.56.excalidraw]]
>```
>```col-md
>* **~={blue}Shared Lock=~**: Prevents T2 from deleting data T1 is currently reading/has a shared lock on.
>* **~={red}Prevents new rows or deleted rows from appearing in a repeated read.=~**
>```
>````

>[!Note]- Concurrency Control Mechanisms: Optimistic Concurrency Control
> <!-- Multiline -->
> **~={blue}Traits=~**:
> * Optimistic Concurrency Control **(OCC)** allows transactions to proceed **without locking** but performs **validation before commit** to detect conflicts. If a conflict is detected, the transaction **rolls back and retries**.
> * It works on a local copy of data, and updates the database afterwards.
> * It uses **~={green}versioning=~**, where whenever an en=ty is updated its version
number is incremented.
>
> **~={blue}How it Prevents=~**:
>1. **~={red}Lost Update=~**:
>````col
>```col-md
>**~={green}With Pessimistic Locking=~**
> ![[Drawing 2025-02-05 13.02.51.excalidraw]]
>
>```
>```col-md
>**~={red}Why it Works=~**
>* **~={blue}Exclusive Lock=~**: Prevents T2 from reading and updating data that T1 has an exclusive lock on. Hence we cannot write to stale data.
>* **~={red}Ensures only one transaction modifies a row at a time.=~**
>```
>````
>2. **~={red}Dirty Read=~**:
>````col
>```col-md
> ![[Drawing 2025-02-05 13.10.31.excalidraw]]
>```
>```col-md
>**~={red}Why it Works=~**
>* **~={blue}Exclusive Lock=~**: Prevents T2 from reading data that T1 has an exclusive lock on. Hence, we cannot read stale data.
>* **~={red}Prevents reading uncommitted changes.=~**
>```
>````
> 

>[!Note]- Deadlock Prevention
> <!-- Multiline -->
> * **~={blue}A Write Operation=~**: Updates the value on the disk
> * **~={blue}Commit Operation=~**: Makes the change permanent
>3. **~={red}Lost Update=~**:
>````col
>```col-md
> ![[Drawing 2025-02-05 08.10.23.excalidraw | center | 450]]
>```
>```col-md
>* T1 Updates X
>* T2 Updates X
>* T1 Changes are Written to the Disk
>* T2 Changes are Written to the Disk without accounting for T1's Changes
>```
>````
>4. **~={red}Dirty Read=~**:
>````col
>```col-md
>![[Drawing 2025-02-04 08.34.07.excalidraw | center | 450]]
>```
>```col-md
>* T1 Updates X
>* T2 Reads Updated X
>* T1 Fails for Some Reason. Hence the value that T2 read is no longer correct.
>```
>````
> 
>5. **~={red}Unrepeatable Read=~**:
>````col
>```col-md
> ![[Drawing 2025-02-05 08.15.50.excalidraw | center | 450]]
>```
>```col-md
>* T1 and T2 Read X
>* T1 Updates X
>* T2 Reads X
>* T2 read X twice in the same transaction but it yielded a different value each time. This should not happen.
>```
>````
>6. **~={red}Phantom Read=~**:
>````col
>```col-md
> ![[Drawing 2025-02-05 08.27.56.excalidraw | center | 450]]
>```
>```col-md
>* T1 and T2 Read X
>* T1 Deletes X
>* T2 Reads X
>* T2 Reads X, but the value has now been deleted leading to an error
>```
>````

# NoSQL (Non Relational)

>[!Note]- When to use a Non-Relational Database
> <!-- Multiline -->
> 1. **~={purple}Structured Data=~**:
> 2. **~={purple}ACID=~**:
> 3. **~={purple}Frequent Joins=~**:
> 

>[!Note]- Document Database
> <!-- Multiline -->
> 

>[!Note]- Graph Database
> <!-- Multiline -->
> 

>[!Note]- Log Structured Storage (LSM)
> <!-- Multiline -->
> 

>[!Note]- Column Store
> <!-- Multiline -->
> 
